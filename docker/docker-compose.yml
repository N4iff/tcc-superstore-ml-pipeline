# Docker Compose configuration for Superstore ML Pipeline
# 
# Usage:
#   cd docker
#   docker compose --env-file ../.env up
#
# Or from project root:
#   docker compose -f docker/docker-compose.yml --env-file .env up
#
# Note: --env-file is required for variable substitution in docker-compose.yml
#       (e.g., ${POSTGRES_DB}, ${MODEL_URI})

services:
  db:
    image: postgres:16
    container_name: superstore-db
    restart: unless-stopped
    env_file:
      - ../.env
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - superstore_db_data:/var/lib/postgresql/data
      - ../sql/schema.sql:/docker-entrypoint-initdb.d/01_schema.sql:ro

  mlflow:
    # MLflow Tracking Server
    image: ghcr.io/mlflow/mlflow:v2.14.2
    container_name: superstore-mlflow
    restart: unless-stopped
    env_file:
      - ../.env
    ports:
      - "5001:5000"
    volumes:
      - mlflow_data:/mlflow
    command: >
      mlflow server
      --host 0.0.0.0
      --port 5000
      --backend-store-uri sqlite:////mlflow/mlflow.db
      --serve-artifacts
      --artifacts-destination /mlflow/artifacts

  api:
    # FastAPI application
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: superstore-api
    restart: unless-stopped
    env_file:
      - ../.env
    environment:
      DB_HOST: db
      DB_PORT: 5432
      MLFLOW_TRACKING_URI: http://mlflow:5000
      MODEL_URI: ${MODEL_URI}
      MODEL_PATH: ${MODEL_PATH}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_QUEUE: predict_jobs
    depends_on:
      - db
      - mlflow
      - rabbitmq
    ports:
      - "8000:8000"

  rabbitmq:
    image: rabbitmq:3-management
    container_name: superstore-rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"    # AMQP
      - "15672:15672"  # Management UI

  worker:
    build:
      context: ..
      dockerfile: Dockerfile
    restart: unless-stopped
    command: python src/worker/worker.py
    env_file:
      - ../.env
    environment:
      DB_HOST: db
      DB_PORT: 5432
      MLFLOW_TRACKING_URI: http://mlflow:5000
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_QUEUE: predict_jobs
    depends_on:
      - rabbitmq
      - db
      - mlflow



volumes:
  superstore_db_data:
  mlflow_data:
